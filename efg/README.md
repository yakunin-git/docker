# EFG (Elasticsearch, Fluent Bit, Grafana)

## О проекте

Я очень долгое время пользовался классическим стеком ELK, всем он был хорош. Но время идет, все меняется. И на смену тяжелым java приложениям, приходят менее «прожорливые» написанные на C или на Go. По этому, родился этот стек для меня. В качестве эксперимента я собрал для себя, стек EFG, заменив тяжелый Logstach на легкий и удобный Fluent Bit, и неповоротливую Kibana на изящную Grafana. Единственное что пока остается без изменений это Elasticsearch.

## Развертывание

Структура такова, папка conf содержит файлы конфигурации Fluent Bit, куда входят: основной файл конфигурации и парсер для обработки логов. В основном файле конфигурации мы следим за файлом /var/log/fluent-bit.log, и как только в него сносятся изменения, или добавляется строка, парсер обрабатывает строку и передает её как в stdout так и в Elasticsearch. Для удобства заполнения данными в корне проекта находиться файл efg_generator.py это небольшой скрипт на Python который генерирует строки вида:

```
Маслов Альфред Эдуардович 41 Подольск 890 1.500000
Сысоев Лука Христофорович 34 Серпухов 760 3.700000
Исаков Аркадий Парфеньевич 38 Подольск 700 1.500000
Никонов Панкратий Федосеевич 42 Суздаль 890 6.300000
```

Строки выводятся на экран и записываются в файл /var/log/fluent-bit.log, далее парсер разбивает строки и передает их в Elasticsearch. Так же в корне проекта находиться файл grafana_dashboard.json это Dashboard для Grafana который отображает полученные данные из Elasticsearch.


Настройки для Grafana следующие, необходимо создать Datasource в качестве источника указать Elasticsearch, в качестве хоста указать http://elasticsearch:9200, в качестве имени индекса необходимо указать fluent*, версия Elasticsearch +8., далее сохранить полученный источник. Подразумевается что стек уже запущен. 


## Порядок запуска

1. Необходимо запустить стек:

```
docker compose up –detach
```
В новой версии docker через есть собственный plugin docker compose, который не требует его отдельной установки. Прочитайте об этом на официальном сайте docker.

2. После запуска, запустите генератор записей

```
python efg_generator.py
```

3. Зайдите в интерфес графаны через браузер: http://127.0.0.1:3000, смените пароль по умолчанию и добавьте необходимый источник как указано выше. После чего импортируйте Dashboard и вы увидете как заполняются даные.

## Что дальше?

Данный стек собран как пример. Далее вы можете применять любые регулярные выражения для различных файлов, а в конфигурации Fluent Bit указывать слежение за теми файлами и логами которые вам необходимы. Агрегировать данные с помощью Grafana.

## Возможные проблемы.

Что бы сохранять данные после перезапуска или остановке стека, в docker-compose.yml указаны volume. Docker автоматически создат эти директории в корневой папке, но вы можете получить ошибку доступа к этим директориям, т.к. docker
работает от другого пользователя, назначте соотвествующие права на эти диретории. Перезапустите стек.
